# üî¥ –ü–æ–ª–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –≤ –ø—Ä–æ–µ–∫—Ç–µ TechnoBot

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Redis –≤ –ø—Ä–æ–µ–∫—Ç–µ

```mermaid
graph TB
    %% –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    subgraph "üîß –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏"
        A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] --> B[Middleware]
        B --> C{Redis –¥–æ—Å—Ç—É–ø–µ–Ω?}
        C -->|–î–∞| D[Redis Rate Limiting]
        C -->|–ù–µ—Ç| E[–õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à]
        D --> F[–°—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤]
        E --> F
        F --> G{–õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω?}
        G -->|–î–∞| H[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞]
        G -->|–ù–µ—Ç| I[–ü—Ä–æ–ø—É—Å–∫ –∑–∞–ø—Ä–æ—Å–∞]
    end

    subgraph "üõ°Ô∏è Redis –æ–ø–µ—Ä–∞—Ü–∏–∏"
        J[INCR user:123:quota] --> K[TTL 3600s]
        L[GET user:123:quota] --> M[–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞]
        N[EXPIRE user:123:quota 3600] --> O[–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ]
    end

    subgraph "üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏"
        P[redis-cli KEYS user:*:quota] --> Q[–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–æ—Ç—ã]
        R[redis-cli INFO stats] --> S[–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis]
        T[TTL –ø—Ä–æ–≤–µ—Ä–∫–∞] --> U[–í—Ä–µ–º—è –¥–æ —Å–±—Ä–æ—Å–∞]
    end

    subgraph "üîÑ Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è"
        V[–û—à–∏–±–∫–∞ Redis] --> W[–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å]
        W --> X[–°—á–µ—Ç—á–∏–∫ –≤ –ø–∞–º—è—Ç–∏]
        X --> Y[–°–±—Ä–æ—Å –ø–æ —á–∞—Å–∞–º]
    end

    subgraph "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
        Z[REDIS_AVAILABLE] --> AA[–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞]
        BB[redis.from_url] --> CC[–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ]
        DD[decode_responses=True] --> EE[UTF-8 —Å—Ç—Ä–æ–∫–∏]
    end

    %% –°–≤—è–∑–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    A --> J
    D --> J
    F --> L
    G --> T
    C --> V
    V --> W
    AA --> BB
    BB --> DD

    %% –°—Ç–∏–ª–∏
    classDef redisNode fill:#ff6b6b,stroke:#d63031,stroke-width:2px,color:#fff
    classDef fallbackNode fill:#74b9ff,stroke:#0984e3,stroke-width:2px,color:#fff
    classDef monitoringNode fill:#55a3ff,stroke:#2d3436,stroke-width:2px,color:#fff
    classDef configNode fill:#a29bfe,stroke:#6c5ce7,stroke-width:2px,color:#fff

    class D,J,K,L,M,N,O redisNode
    class E,W,X,Y fallbackNode
    class P,Q,R,S,T,U monitoringNode
    class Z,AA,BB,CC,DD,EE configNode
```

## üîß –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã Redis

```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant M as Middleware
    participant R as Redis
    participant L as –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
    participant B as –ë–æ—Ç

    Note over U,B: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    U->>M: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    M->>M: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç REDIS_AVAILABLE
    
    alt Redis –¥–æ—Å—Ç—É–ø–µ–Ω
        M->>R: INCR user:{id}:quota
        R->>M: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫
        
        alt –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
            M->>R: EXPIRE user:{id}:quota 3600
        end
        
        M->>M: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç (50/—á–∞—Å)
        
        alt –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
            M->>U: "–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω"
        else –õ–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω
            M->>B: –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
        end
        
    else Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        M->>L: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        L->>M: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫
        
        M->>M: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç
        
        alt –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
            M->>U: "–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω"
        else –õ–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω
            M->>B: –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
        end
    end
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö Redis

```mermaid
graph LR
    subgraph "üîë –ö–ª—é—á–∏ Redis"
        A[user:123:quota] --> B[–°—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤]
        C[user:456:quota] --> D[TTL 3600s]
        E[user:789:quota] --> F[–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ]
    end

    subgraph "üìà –û–ø–µ—Ä–∞—Ü–∏–∏"
        G[INCR] --> H[–ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ]
        I[EXPIRE] --> J[–£—Å—Ç–∞–Ω–æ–≤–∫–∞ TTL]
        K[TTL] --> L[–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏]
        M[GET] --> N[–ß—Ç–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è]
    end

    subgraph "üõ°Ô∏è –ó–∞—â–∏—Ç–∞"
        O[50 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å] --> P[–õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
        Q[3600 —Å–µ–∫—É–Ω–¥] --> R[–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–ª—é—á–∞]
        S[0.8 * –ª–∏–º–∏—Ç] --> T[–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ]
    end

    A --> G
    C --> I
    E --> K
    B --> O
    D --> Q
    F --> S
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Redis –∫–ª—é—á–∞

```mermaid
stateDiagram-v2
    [*] --> –°–æ–∑–¥–∞–Ω–∏–µ
    –°–æ–∑–¥–∞–Ω–∏–µ --> –ê–∫—Ç–∏–≤–µ–Ω: INCR
    –ê–∫—Ç–∏–≤–µ–Ω --> –£–≤–µ–ª–∏—á–µ–Ω–∏–µ: –ó–∞–ø—Ä–æ—Å
    –£–≤–µ–ª–∏—á–µ–Ω–∏–µ --> –ê–∫—Ç–∏–≤–µ–Ω: < 50
    –£–≤–µ–ª–∏—á–µ–Ω–∏–µ --> –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: >= 50
    –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ --> –û–∂–∏–¥–∞–Ω–∏–µ: TTL > 0
    –û–∂–∏–¥–∞–Ω–∏–µ --> –£–¥–∞–ª–µ–Ω–∏–µ: TTL = 0
    –£–¥–∞–ª–µ–Ω–∏–µ --> [*]
    
    –ê–∫—Ç–∏–≤–µ–Ω --> –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: > 40
    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ --> –ê–∫—Ç–∏–≤–µ–Ω: < 50
    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ --> –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: >= 50
```

## üìã –ö–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```mermaid
graph TD
    subgraph "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
        A[redis-cli ping] --> B[–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è]
        C[redis-cli KEYS user:*:quota] --> D[–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–æ—Ç—ã]
        E[redis-cli INFO stats] --> F[–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞]
        G[redis-cli TTL user:123:quota] --> H[–í—Ä–µ–º—è –¥–æ —Å–±—Ä–æ—Å–∞]
    end

    subgraph "üìä –ú–µ—Ç—Ä–∏–∫–∏"
        I[–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π] --> J[–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É]
        K[–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–ª—é—á–µ–π] --> L[–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TTL]
        M[–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤] --> N[–ö–∞—á–µ—Å—Ç–≤–æ –∑–∞—â–∏—Ç—ã]
    end

    subgraph "üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
        O[redis-cli FLUSHDB] --> P[–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö]
        Q[redis-cli DEL user:123:quota] --> R[–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–≤–æ—Ç—ã]
        S[redis-cli CONFIG SET maxmemory] --> T[–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–º—è—Ç–∏]
    end

    B --> I
    D --> K
    F --> M
    H --> N
```

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º

```mermaid
graph TB
    subgraph "ü§ñ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç"
        A[bot.py] --> B[–ò–º–ø–æ—Ä—Ç redis.asyncio]
        B --> C[REDIS_AVAILABLE –ø—Ä–æ–≤–µ—Ä–∫–∞]
        C --> D[Middleware –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è]
    end

    subgraph "üõ°Ô∏è Middleware"
        E[HourlyLimitMiddleware] --> F[–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤]
        F --> G[Redis –æ–ø–µ—Ä–∞—Ü–∏–∏]
        G --> H[Fallback –ª–æ–≥–∏–∫–∞]
    end

    subgraph "üìä –ö–æ–º–∞–Ω–¥—ã"
        I[/test_limits] --> J[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞]
        J --> K[Redis –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞]
        K --> L[–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫]
    end

    subgraph "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
        M[requirements.txt] --> N[redis>=5]
        O[run_improvements.sh] --> P[–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Redis]
        Q[FIX_PYTHON_313.md] --> R[–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å]
    end

    A --> E
    E --> I
    I --> M
    M --> O
    O --> Q
```

## üìù –†–µ–∑—é–º–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Redis

### ‚úÖ **–ß—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis:**
- **Rate Limiting** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π TTL** - —Å–∞–º–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤

### ‚ùå **–ß—Ç–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis:**
- **–û—á–µ—Ä–µ–¥–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤** - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –ø–∞–º—è—Ç–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ RAG** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ChromaDB
- **–°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ FSM
- **–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** - –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ

### üîß **–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **Graceful degradation** - fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Python 3.13** - –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ª–∏–º–∏—Ç—ã** - 50 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 