# üöÄ –£–ª—É—á—à–µ–Ω–∏—è –±–æ—Ç–∞ TechnoBot

## üìÖ –ù–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ä—É—Å—Å–∫–∏—Ö –¥–∞—Ç

### –ü—Ä–æ–±–ª–µ–º–∞
–†–∞–Ω–µ–µ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç –≤—ã–ø–æ–ª–Ω—è–ª—Å—è —Å–∞–º–æ–ø–∏—Å–Ω—ã–º–∏ regex, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:
- –†–∞–∑–Ω—ã—Ö —Å–∫–ª–æ–Ω–µ–Ω–∏–π –º–µ—Å—è—Ü–µ–≤ ("—è–Ω–≤–∞—Ä—è" vs "—è–Ω–≤–∞—Ä—å")
- –†–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ ("–≥." vs "–≥–æ–¥–∞")
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤
- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞—Ç ("–∑–∞–≤—Ç—Ä–∞", "—á–µ—Ä–µ–∑ 3 –¥–Ω—è")

### –†–µ—à–µ–Ω–∏–µ
–í–Ω–µ–¥—Ä–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `dateparser` —Å fallback –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—ã–π regex:

```python
def parse_russian_date(text: str, default_year: int = None) -> Optional[datetime]:
    """
    –ù–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Ä—É—Å—Å–∫–∏—Ö –¥–∞—Ç —Å fallback –Ω–∞ dateparser
    """
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º dateparser (–Ω–∞–¥—ë–∂–Ω–µ–µ)
    dt = dateparser.parse(clean_text, languages=['ru'])
    
    # Fallback –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π regex
    if not dt:
        dt = regex_parse(text)
    
    return dt
```

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–π (—è–Ω–≤–∞—Ä—å/—è–Ω–≤–∞—Ä—è)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ '–≥.' –∏ '–≥–æ–¥–∞'
- ‚úÖ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞—Ç—ã (–∑–∞–≤—Ç—Ä–∞, —á–µ—Ä–µ–∑ N –¥–Ω–µ–π)
- ‚úÖ Fallback –Ω–∞ regex –ø—Ä–∏ —Å–±–æ–µ dateparser
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
/test_date_parser  # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ API

### –ü—Ä–æ–±–ª–µ–º–∞
–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥:
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Ç–Ω–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥
- –ò—Å—á–µ—Ä–ø–∞—Ç—å –∫–≤–æ—Ç—É API –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –†–µ—à–µ–Ω–∏–µ
–í–Ω–µ–¥—Ä–µ–Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã:

#### 1. –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å (Redis)
```python
class HourlyLimitMiddleware(BaseMiddleware):
    def __init__(self, limit_per_hour: int = 50):
        self.limit = limit_per_hour
        
    async def __call__(self, handler, event, data):
        key = f"user:{user_id}:quota"
        used = await redis.incr(key)
        if used == 1:
            await redis.expire(key, 3600)  # TTL 1 —á–∞—Å
        
        if used > self.limit:
            await event.answer("‚åõ –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Å")
            return
```

#### 2. –°–µ–º–∞—Ñ–æ—Ä –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤
```python
LLM_CONCURRENCY = 10
llm_semaphore = asyncio.Semaphore(LLM_CONCURRENCY)

async def ask_llm(prompt):
    async with llm_semaphore:  # –ú–∞–∫—Å–∏–º—É–º 10 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        return await deepseek_api(prompt)
```

#### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π back-off –Ω–∞ HTTP 429
```python
@retry(
    wait=wait_exponential(multiplier=1, min=2, max=60),
    stop=stop_after_attempt(5)
)
async def _make_request(self, payload: dict):
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ø—Ä–∏ rate limit
    if response.status == 429:
        retry_after = response.headers.get('Retry-After', '60')
        await asyncio.sleep(int(retry_after))
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞—â–∏—Ç—ã
- **–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤:** 50/—á–∞—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö LLM:** 10 –∑–∞–ø—Ä–æ—Å–æ–≤
- **Retry –ø–æ–ø—ã—Ç–∫–∏:** 5 —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º back-off
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP 429:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
/test_limits  # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤
```

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
# –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç
dateparser>=1.1.8

# –õ–∏–º–∏—Ç—ã API –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
aioredis>=2.0.0
tenacity>=8.2.0
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
# Ubuntu/Debian
sudo apt install redis-server

# macOS
brew install redis

# –ó–∞–ø—É—Å–∫ Redis
redis-server
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑ Redis
–ï—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à.

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –∑–∞—â–∏—Ç—ã
```python
# –ë–ª–∏–∑–∫–∏–µ –∫ –ª–∏–º–∏—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
logger.warning(f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –±–ª–∏–∑–æ–∫ –∫ –ª–∏–º–∏—Ç—É: {used}/{limit}")

# –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤
logger.error(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç: {used}/{limit}")

# Rate limit –æ—Ç API
logger.warning(f"‚ö†Ô∏è Rate limit (429), retry after {retry_after}s")
```

### –ú–µ—Ç—Ä–∏–∫–∏ Redis
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–æ—Ç
redis-cli KEYS "user:*:quota"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
redis-cli INFO stats
```

---

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚ùå –ù–µ—Ç–æ—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç
- ‚ùå –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å DDoS –æ–¥–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚ùå –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ API

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚úÖ –ù–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –ª—é–±—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –¥–∞—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- ‚úÖ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- `/test_date_parser` - —Ç–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç
- `/test_limits` - —Å—Ç–∞—Ç—É—Å –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–∏–º–∏—Ç–æ–≤
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Middleware ‚Üí Redis/LocalCache ‚Üí –°–µ–º–∞—Ñ–æ—Ä ‚Üí LLM API
                 ‚Üì              ‚Üì                ‚Üì         ‚Üì
              –ü—Ä–æ–≤–µ—Ä–∫–∞      –°—á–µ—Ç—á–∏–∫         –û—á–µ—Ä–µ–¥—å   Retry
              –ª–∏–º–∏—Ç–æ–≤      –∑–∞–ø—Ä–æ—Å–æ–≤         –∑–∞–ø—Ä–æ—Å–æ–≤  –ª–æ–≥–∏–∫–∞
```

### Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
1. **Redis –¥–æ—Å—Ç—É–ø–µ–Ω** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∫—ç—à
2. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** ‚Üí –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
3. **API rate limit** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π back-off
4. **Dateparser —Å–±–æ–π** ‚Üí fallback –Ω–∞ regex

–≠—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞ –¥–∞–∂–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –∏ –∑–∞—â–∏—â–∞—é—Ç –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π API. 