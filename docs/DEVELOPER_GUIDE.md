# TechnoBot-DO — Руководство разработчика

Ниже — полный разбор устройства бота, архитектуры, модулей, команд, состояний и интеграций. Документ рассчитан на разработчика, которому передают поддержку/развитие проекта.

## 1. Обзор проекта
- Назначение: Telegram-бот Национального детского технопарка (НДТ). Общается на русском языке и помогает: рассказать о технопарке, показать календарь смен, проверить списки, пройти профориентационный квиз, провести брейншторм идей проекта, связаться с консультантом (оператором) и т.д.
- Стек: Python 3.10+, aiogram (v3), aiohttp, опционально Redis для лимитов запросов, интеграция с DeepSeek Chat API (стриминг и обычный режим).
- Основные модули:
  - `bot.py` — точка входа, инициализация бота/диспетчера, middleware, регистрации команд и хендлеров, главное меню.
  - `brainstorm_mod.py` — брейншторм идей проекта: FSM, вопросы от LLM, форматирование Markdown (md_fix), меню старта/выхода.
  - `quiz_mod.py` — профориентационный квиз: запуск из команды и по inline-кнопке, FSM, семафор для LLM.
  - `operator_handler.py` — логика эскалации к консультанту, очередь, статусы, сообщения.
  - Доп. модули (при наличии): `schedule_parser`, `documents_parser`, RAG-реализации, `notification_system` и др.

## 2. Быстрый старт (локально)
1) Python 3.10+ (проверьте: `python3 --version`).
2) Создать и активировать виртуальное окружение:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```
3) Установить зависимости:
   ```bash
   python3 -m pip install --upgrade pip
   python3 -m pip install -r requirements.txt
   ```
4) Создать файл окружения `.env` (см. раздел «Переменные окружения»). Минимум нужен `TELEGRAM_BOT_TOKEN` и при использовании LLM — `DEEPSEEK_API_KEY`.
5) Запустить бота:
   ```bash
   python3 bot.py
   ```

## 3. Переменные окружения
Создайте `.env` в корне проекта или иным способом передайте переменные в окружение процесса.
- TELEGRAM_BOT_TOKEN — токен Telegram-бота.
- DEEPSEEK_API_KEY — ключ для DeepSeek Chat API (если используется LLM).
- ADMIN_IDS — список числовых Telegram ID админов, через запятую, например: `12345,67890`.
- REDIS_URL — (опционально) URL Redis, например `redis://localhost:6379/0`. В исходном коде по умолчанию используется локальный Redis; при наличии переменной корректируйте инициализацию.
- Прочие переменные модулей — по месту использования.

Примечание: .gitignore уже игнорирует `.env` и `.env*`.

## 4. Запуск команд в боте
Команды регистрируются в меню Telegram при старте (set_my_commands):
- /start — приветствие и ветвление по ролям (админ/оператор/пользователь).
- /menu — показать главное меню (то же, что inline «Назад в меню»).
- /calendar — календарь смен (если модуль доступен).
- /quiz — запуск квиза (если модуль доступен).
- /brainstorm — запуск брейншторма (если модуль доступен).
- /checklists — проверка списков (если модуль доступен).
- /help — связь с консультантом (эскалация запроса оператору).

Inline-кнопки в главном меню зеркалируют действия многих команд.

## 5. Основные файлы и их назначение
- bot.py
  - Инициализация: Bot/Dispatcher, middleware (HourlyLimitMiddleware), семафор для LLM (`llm_semaphore`).
  - Регистрация команд (set_my_commands) и хендлеры: /start, /menu, /help, /status, /calendar, /quiz, /checklists и др.
  - Главное меню: кнопки «О технопарке», «Направления обучения», «Поступление», «Календарь смен», «Проверить списки», «Квиз», «Брейншторм идей», «Связаться с консультантом».
  - Callback-хендлеры для соответствующих кнопок (например, `show_calendar`).
  - Интеграция с `operator_handler` для /help и очереди к консультантам.

- brainstorm_mod.py
  - FSM состояния: выбор направления и активный брейншторм.
  - Интеграция с LLM (DeepSeek). Хелпер `md_fix()` — переводит **жирный** в *жирный* для Telegram Markdown.
  - Обработчики: /brainstorm и inline «start_brainstorm». Везде parse_mode="Markdown".

- quiz_mod.py
  - Запуск квиза из команды (/quiz) и callback-кнопки («start_quiz»), FSM и логика.
  - Семафор LLM, форматирование сообщений, регистрация хендлеров `register_quiz_handlers`.

- operator_handler.py
  - Эскалация к оператору, очередь, статусы, сообщения, состояния оператора.

- Дополнительные парсеры/модули (если есть в репозитории):
  - schedule_parser — генерация интерфейса календаря, `get_calendar_interface()`.
  - documents_parser — проверки списков.
  - RAG — поиск по материалам.
  - notification_system — шаблоны уведомлений.

## 6. Лимиты, Redis и middleware
`HourlyLimitMiddleware(limit_per_hour=50)` — ограничение запросов на пользователя/час.
- Если доступен Redis (`REDIS_AVAILABLE`), используется ключ `user:{id}:quota`, TTL 1 час.
- Если Redis недоступен — fallback на локальный in-memory кэш (сброс ежечасно).
- Конфиг Redis (URL/инициализация) при необходимости поправьте в `bot.py`.

## 7. Роли пользователей
- Admin — определяется по `ADMIN_IDS`. Для админов /start отправляет специальный текст и панель.
- Operator — определяется через `operator_handler.operator_manager.is_operator(user_id)`; операторы получают свои подсказки/панель.
- User — дефолтный сценарий: приветствие + главное меню.

## 8. Форматирование Markdown
Весь пользовательский контент отправляется с `parse_mode="Markdown"`.
- Статический текст: используйте одинарные `*` для жирного и `_` для курсивного.
- Динамический текст от LLM прогоняется через `md_fix()` (замена ** → * и __ → _).

## 9. Добавление новых команд/кнопок
1) Добавьте хендлер команды `@dp.message(Command("new"))` и логику.
2) Для inline — создайте `InlineKeyboardButton(..., callback_data="...")` и callback-хендлер.
3) Обновите `set_my_commands` (on startup) для отображения команды в меню Telegram.

## 10. Запуск в продакшене (вариант)
- Systemd unit или контейнер. Важно обеспечить перезапуск процесса и логи.
- Настройка переменных окружения/секретов (TOKEN, API-keys).
- Redis как внешний сервис для централизованных лимитов.

## 11. Логи и отладка
- Логи пишутся в stdout (и/или в `logs/` при наличии конфигурации). `.gitignore` уже исключает `*.log` и `logs/`.
- Для детальной отладки: временно повышайте уровень логирования, добавляйте контекст (user_id, state).

## 12. Тестирование
- Юнит-тесты для отдельных функций.
- Интеграционно прогоните основные сценарии: /start, /menu, /help, /brainstorm, /quiz, /calendar, /checklists.

## 13. Точки расширения
- Добавить новые направления брейншторма.
- Подключить дополнительные провайдеры LLM.
- Расширить RAG.
- Усложнить обработку операторов (SLA, приоритеты, статистика).

## 14. Типичные проблемы
- "Flood control" от Telegram — добавляйте задержки или снижайте частоту отправки.
- Неправильное Markdown — используйте `md_fix` и одинарные `*`/`_`.
- Redis недоступен — бот использует fallback, но лимиты будут локальные.

## 15. Полезные команды
```bash
# Разработка
source venv/bin/activate
python3 -m pip install -r requirements.txt
python3 bot.py

# Линтеры/форматтеры (если добавите)
ruff check .
black .
pytest -q
```

---
Если возникнут вопросы — см. исходники соответствующих модулей. Архитектура модульная и расширяемая.
